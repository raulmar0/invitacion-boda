<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Boda | Maritza & Jaime</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #333; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .tooltip.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-8">
            <h3 class="font-serif text-2xl text-black mb-4">Acceso Restringido</h3>
            <p class="text-gray-600 mb-6">Por favor, introduce la contraseña para acceder al panel de administración.</p>
            <form id="password-form">
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black" placeholder="Contraseña">
                <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta.</p>
                <button type="submit" class="mt-4 w-full bg-black text-white py-3 px-8 rounded-full font-semibold uppercase tracking-wider hover:bg-gray-800">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard Content (hidden by default) -->
    <div id="dashboard-content" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold font-serif text-gray-900">Panel de Boda de Maritza & Jaime</h1>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Stats Section -->
            <section id="stats-section">
                <h2 class="text-2xl font-semibold mb-4 px-4 sm:px-0">Resumen de Invitados</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <p class="text-4xl font-bold text-blue-600" id="total-guests">0</p>
                        <p class="text-gray-500 mt-1">Total de Invitaciones</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <p class="text-4xl font-bold text-green-600" id="confirmed-guests">0</p>
                        <p class="text-gray-500 mt-1">Confirmados</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <p class="text-4xl font-bold text-yellow-600" id="pending-guests">0</p>
                        <p class="text-gray-500 mt-1">Pendientes</p>
                    </div>
                </div>
            </section>

            <!-- Add Guest Section -->
            <section id="add-guest-section" class="mt-12">
                <h2 class="text-2xl font-semibold mb-4 px-4 sm:px-0">Agregar Nueva Invitación</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <form id="add-guest-form" class="space-y-4">
                        <div>
                            <label for="guest-names" class="block text-sm font-medium text-gray-700">Nombres de los invitados</label>
                            <input type="text" id="guest-names" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black" placeholder="Ej: Ana López, Carlos García (separados por coma)" required>
                            <p class="text-xs text-gray-500 mt-1">Si es más de un invitado, sepáralos por comas.</p>
                        </div>
                        <div>
                            <label for="passes-allocated" class="block text-sm font-medium text-gray-700">Número de pases</label>
                            <input type="number" id="passes-allocated" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black" min="1" required>
                        </div>
                        <button type="submit" id="add-guest-btn" class="w-full sm:w-auto bg-black text-white py-3 px-8 rounded-full font-semibold uppercase tracking-wider hover:bg-gray-800 disabled:bg-gray-400">Agregar Invitado</button>
                    </form>
                </div>
            </section>

            <!-- Guest List Section -->
            <section id="guest-list-section" class="mt-12">
                <h2 class="text-2xl font-semibold mb-4 px-4 sm:px-0">Lista de Invitados</h2>
                <div id="guest-list-container" class="space-y-4">
                    <div id="list-loader" class="flex justify-center items-center h-32">
                        <div class="loader"></div>
                    </div>
                    <!-- Guest cards will be inserted here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Guest Modal -->
    <div id="edit-guest-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-serif text-2xl text-black">Detalles de la Invitación</h3>
                <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <form id="edit-guest-form" class="space-y-4">
                <input type="hidden" id="edit-guest-id">
                <div>
                    <label for="edit-guest-names" class="block text-sm font-medium text-gray-700">Nombres de los invitados</label>
                    <input type="text" id="edit-guest-names" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black" placeholder="Ej: Ana López, Carlos García" required>
                </div>
                <div>
                    <label for="edit-passes-allocated" class="block text-sm font-medium text-gray-700">Número de pases</label>
                    <input type="number" id="edit-passes-allocated" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black" min="1" required>
                </div>
                <button type="submit" id="update-guest-btn" class="w-full bg-blue-600 text-white py-3 px-8 rounded-full font-semibold uppercase tracking-wider hover:bg-blue-700 disabled:bg-gray-400">Guardar Cambios</button>
            </form>

            <div id="confirmation-details" class="mt-6 border-t pt-4 space-y-2">
                <!-- Details will be injected here -->
            </div>

            <div class="mt-6 border-t pt-4 flex flex-col sm:flex-row gap-4">
                 <button id="modal-generate-link-btn" class="w-full bg-gray-800 text-white py-2 px-4 rounded-full font-semibold text-sm hover:bg-black relative">
                    Generar Link de Invitación
                    <div class="tooltip">Copiado!</div>
                </button>
                <button id="delete-guest-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-full font-semibold text-sm hover:bg-red-700">Eliminar Invitación</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOwGMwUKJ8Poup51q8_mXty4-oLe9eGO0",
            authDomain: "boda-martiza-jaime.firebaseapp.com",
            projectId: "boda-martiza-jaime",
            storageBucket: "boda-martiza-jaime.firebasestorage.app",
            messagingSenderId: "106564189041",
            appId: "1:106564189041:web:55b6054892b28894bb14d0"
        };
        
        const ACCESS_PASSWORD = "boda"; 

        // --- DOM Elements ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const dashboardContent = document.getElementById('dashboard-content');
        const totalGuestsEl = document.getElementById('total-guests');
        const confirmedGuestsEl = document.getElementById('confirmed-guests');
        const pendingGuestsEl = document.getElementById('pending-guests');
        const addGuestForm = document.getElementById('add-guest-form');
        const guestListContainer = document.getElementById('guest-list-container');
        const listLoader = document.getElementById('list-loader');
        
        // Edit Modal Elements
        const editGuestModal = document.getElementById('edit-guest-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editGuestForm = document.getElementById('edit-guest-form');
        const editGuestIdInput = document.getElementById('edit-guest-id');
        const editGuestNamesInput = document.getElementById('edit-guest-names');
        const editPassesAllocatedInput = document.getElementById('edit-passes-allocated');
        const updateGuestBtn = document.getElementById('update-guest-btn');
        const confirmationDetailsContainer = document.getElementById('confirmation-details');
        const modalGenerateLinkBtn = document.getElementById('modal-generate-link-btn');
        const deleteGuestBtn = document.getElementById('delete-guest-btn');

        let db;

        // --- Password Check ---
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (e.target.elements['password-input'].value === ACCESS_PASSWORD) {
                passwordModal.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                initializeAppAndData();
            } else {
                e.target.elements['password-error'].classList.remove('hidden');
            }
        });

        // --- Main App Logic ---
        async function initializeAppAndData() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                await loadGuests();
            } catch (error) {
                console.error("Firebase Error:", error);
                alert("No se pudo conectar con la base de datos. Revisa la consola para más detalles.");
            }
        }

        // --- Data Loading & Display ---
        async function loadGuests() {
            listLoader.classList.remove('hidden');
            guestListContainer.innerHTML = ''; 
            
            const invitationsCol = collection(db, 'invitations');
            const invitationSnapshot = await getDocs(invitationsCol);
            
            const guestList = invitationSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let confirmedCount = 0;
            
            guestList.sort((a, b) => ((a.guestNames && a.guestNames[0]) || '').localeCompare((b.guestNames && b.guestNames[0]) || ''));

            guestList.forEach(guest => {
                const isConfirmed = guest.status === 'Confirmado';
                if (isConfirmed) confirmedCount++;
                
                const card = document.createElement('div');
                card.className = `guest-card bg-white p-4 rounded-lg shadow-md flex items-center justify-between gap-4 cursor-pointer hover:shadow-lg transition-shadow ${isConfirmed ? 'border-l-4 border-green-500' : 'border-l-4 border-yellow-500'}`;
                card.dataset.guest = JSON.stringify(guest);
                
                const guestNamesDisplay = Array.isArray(guest.guestNames) ? guest.guestNames.join(', ') : 'Invitado sin nombre';

                card.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${guestNamesDisplay}</p>
                        <p class="text-sm text-gray-600">${guest.passesAllocated || 0} ${guest.passesAllocated === 1 ? 'pase' : 'pases'} asignados</p>
                    </div>
                    <div class="flex-shrink-0">
                        <p class="text-sm font-semibold ${isConfirmed ? 'text-green-600' : 'text-yellow-600'}">${guest.status || 'No Confirmado'}</p>
                    </div>
                `;
                guestListContainer.appendChild(card);
            });

            listLoader.classList.add('hidden');
            updateStats(guestList.length, confirmedCount);
        }

        function updateStats(total, confirmed) {
            totalGuestsEl.textContent = total;
            confirmedGuestsEl.textContent = confirmed;
            pendingGuestsEl.textContent = total - confirmed;
        }

        // --- Add Guest Logic ---
        addGuestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const addGuestBtn = e.target.querySelector('button');
            addGuestBtn.disabled = true;
            addGuestBtn.textContent = 'Agregando...';

            const names = e.target.elements['guest-names'].value.split(',').map(name => name.trim()).filter(name => name);
            const passes = parseInt(e.target.elements['passes-allocated'].value, 10);

            if (names.length === 0 || isNaN(passes) || passes < 1) {
                alert("Por favor, completa todos los campos correctamente.");
                addGuestBtn.disabled = false;
                addGuestBtn.textContent = 'Agregar Invitado';
                return;
            }

            try {
                await addDoc(collection(db, "invitations"), {
                    guestNames: names,
                    passesAllocated: passes,
                    status: 'No Confirmado',
                    confirmedGuests: [],
                    createdAt: serverTimestamp()
                });
                addGuestForm.reset();
                await loadGuests();
            } catch (error) {
                console.error("Error al agregar invitado: ", error);
                alert("Hubo un error al guardar el invitado.");
            } finally {
                addGuestBtn.disabled = false;
                addGuestBtn.textContent = 'Agregar Invitado';
            }
        });

        // --- Edit Modal Logic ---
        function openEditModal(guest) {
            editGuestIdInput.value = guest.id;
            editGuestNamesInput.value = Array.isArray(guest.guestNames) ? guest.guestNames.join(', ') : '';
            editPassesAllocatedInput.value = guest.passesAllocated || 1;
            
            let detailsHtml = `<p><strong>Estado:</strong> <span class="${guest.status === 'Confirmado' ? 'text-green-600' : 'text-yellow-600'}">${guest.status || 'No Confirmado'}</span></p>`;
            if (guest.status === 'Confirmado' && Array.isArray(guest.confirmedGuests)) {
                detailsHtml += `<p><strong>Invitados Confirmados:</strong> ${guest.confirmedGuests.join(', ')}</p>`;
                if (guest.confirmedAt && guest.confirmedAt.toDate) {
                    detailsHtml += `<p><strong>Fecha de Confirmación:</strong> ${guest.confirmedAt.toDate().toLocaleString('es-MX')}</p>`;
                }
            }
            confirmationDetailsContainer.innerHTML = detailsHtml;

            editGuestModal.classList.remove('hidden');
            editGuestModal.classList.add('flex');
        }

        function closeEditModal() {
            editGuestModal.classList.add('hidden');
            editGuestModal.classList.remove('flex');
        }

        guestListContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.guest-card');
            if (card) {
                const guestData = JSON.parse(card.dataset.guest);
                openEditModal(guestData);
            }
        });

        closeEditModalBtn.addEventListener('click', closeEditModal);

        editGuestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            updateGuestBtn.disabled = true;
            updateGuestBtn.textContent = 'Guardando...';

            const id = editGuestIdInput.value;
            const names = editGuestNamesInput.value.split(',').map(name => name.trim()).filter(name => name);
            const passes = parseInt(editPassesAllocatedInput.value, 10);

            if (!id || names.length === 0 || isNaN(passes) || passes < 1) {
                alert("Por favor, completa todos los campos correctamente.");
                updateGuestBtn.disabled = false;
                updateGuestBtn.textContent = 'Guardar Cambios';
                return;
            }

            try {
                const guestRef = doc(db, 'invitations', id);
                await updateDoc(guestRef, {
                    guestNames: names,
                    passesAllocated: passes
                });
                closeEditModal();
                await loadGuests();
            } catch (error) {
                console.error("Error al actualizar invitado: ", error);
                alert("Hubo un error al guardar los cambios.");
            } finally {
                updateGuestBtn.disabled = false;
                updateGuestBtn.textContent = 'Guardar Cambios';
            }
        });

        deleteGuestBtn.addEventListener('click', async () => {
            const id = editGuestIdInput.value;
            if (!id) return;

            if (confirm("¿Estás seguro de que quieres eliminar esta invitación? Esta acción no se puede deshacer.")) {
                try {
                    await deleteDoc(doc(db, 'invitations', id));
                    closeEditModal();
                    await loadGuests();
                } catch (error) {
                    console.error("Error al eliminar invitado: ", error);
                    alert("Hubo un error al eliminar la invitación.");
                }
            }
        });

        modalGenerateLinkBtn.addEventListener('click', (e) => {
            const id = editGuestIdInput.value;
            if (!id) return;

            const invitationUrl = `https://boda-martiza-jaime.web.app/?invitacion=${id}`;
            navigator.clipboard.writeText(invitationUrl).then(() => {
                const tooltip = e.target.querySelector('.tooltip');
                tooltip.classList.add('visible');
                setTimeout(() => tooltip.classList.remove('visible'), 2000);
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert('No se pudo copiar el enlace.');
            });
        });

    </script>
</body>
</html>
